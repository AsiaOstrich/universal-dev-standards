#!/bin/sh

# Universal Development Standards - Pre-commit Hook
# This hook runs before each commit to ensure code quality

# Get repository root
REPO_ROOT="$(git rev-parse --show-toplevel)"

# Check if any core/ or ai/standards/ files are staged
STAGED_CORE=$(git diff --cached --name-only | grep -E "^core/.*\.md$" || true)
STAGED_AI=$(git diff --cached --name-only | grep -E "^ai/standards/.*\.ai\.yaml$" || true)

if [ -n "$STAGED_CORE" ] || [ -n "$STAGED_AI" ]; then
    echo "[Pre-commit] Checking standards sync..."
    if [ -f "$REPO_ROOT/scripts/check-standards-sync.sh" ]; then
        "$REPO_ROOT/scripts/check-standards-sync.sh"
        if [ $? -ne 0 ]; then
            echo ""
            echo "When adding/modifying core/*.md or ai/standards/*.ai.yaml, you MUST also:"
            echo "  1. Create/update ai/standards/*.ai.yaml for each core/*.md"
            echo "  2. Update cli/standards-registry.json with source.ai reference"
            echo "  3. Create/update locales/zh-TW/core/*.md"
            echo "  4. Create/update locales/zh-CN/core/*.md"
            echo ""
            exit 1
        fi
    fi
fi

# Check if any CLI or docs files are staged
STAGED_CLI=$(git diff --cached --name-only | grep -E "^cli/bin/.*\.js$" || true)
STAGED_DOCS=$(git diff --cached --name-only | grep -E "^docs/CLI-INIT-OPTIONS\.md$" || true)

if [ -n "$STAGED_CLI" ] || [ -n "$STAGED_DOCS" ]; then
    echo "[Pre-commit] Checking CLI-docs sync..."
    if [ -f "$REPO_ROOT/scripts/check-cli-docs-sync.sh" ]; then
        "$REPO_ROOT/scripts/check-cli-docs-sync.sh"
        if [ $? -ne 0 ]; then
            echo ""
            echo "When adding/modifying CLI options in cli/bin/*.js, you MUST also:"
            echo "  1. Update docs/CLI-INIT-OPTIONS.md"
            echo "  2. Update locales/zh-TW/docs/CLI-INIT-OPTIONS.md"
            echo "  3. Update locales/zh-CN/docs/CLI-INIT-OPTIONS.md"
            echo ""
            exit 1
        fi
    fi
fi

# Navigate to cli directory for npm commands
cd "$REPO_ROOT/cli"

# Run lint-staged for JavaScript files
npx lint-staged

# Run tests
npm test
