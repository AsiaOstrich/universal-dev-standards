# 主幹開發 - AI 優化選項
# 父項: git-workflow

id: trunk-based
meta:
  parent: git-workflow
  version: "1.0.0"
  description: 直接提交到主幹的持續整合工作流程
  language: zh-TW

best_for:
  - 持續部署（每天多次）
  - 成熟的 CI/CD 管線
  - 資深開發團隊
  - 微服務架構

branches:
  - name: main (trunk)
    purpose: 永遠可部署的單一真相來源
    lifetime: 永久

  - name: feature/*
    purpose: 非常短期的功能分支（選用）
    lifetime: 最多 1-2 天
    note: 許多團隊直接提交到 trunk

rules:
  - id: small-frequent-commits
    trigger: 提交程式碼時
    instruction: 小而頻繁的提交（每天多次）
    priority: required

  - id: feature-flags
    trigger: 開發新功能時
    instruction: 使用功能旗標隱藏未完成功能
    priority: required

  - id: trunk-always-green
    trigger: 合併到 trunk 時
    instruction: 所有測試必須通過；trunk 永遠可部署
    priority: required

  - id: no-long-lived-branches
    trigger: 建立分支時
    instruction: 分支存活不超過 2 天
    priority: required

  - id: ci-required
    trigger: 推送變更時
    instruction: 每次推送都必須觸發 CI 管線
    priority: required

workflow:
  direct_commit:
    - step: 從最新 trunk 開始
      commands:
        - git checkout main
        - git pull origin main

    - step: 進行小變更
      commands:
        - "# 進行小而聚焦的變更"
        - git add .
        - git commit -m "feat: {描述}"

    - step: 推送到 trunk
      commands:
        - git pull --rebase origin main
        - git push origin main

  short_branch:
    - step: 建立短期分支
      commands:
        - git checkout main
        - git pull origin main
        - git checkout -b feature/{小功能}

    - step: 快速開發（最多 2 天）
      commands:
        - "# 進行變更..."
        - git add .
        - git commit -m "feat: {描述}"

    - step: 快速合併
      commands:
        - git checkout main
        - git pull origin main
        - git merge --ff-only feature/{小功能}
        - git push origin main

feature_flags:
  description: 使用功能旗標允許不完整程式碼進入 trunk
  example: |
    if (featureFlags.isEnabled('new-checkout')) {
      return <NewCheckout />;
    }
    return <OldCheckout />;

practices:
  - name: 結對程式設計
    benefit: 即時程式碼審查
  - name: 測試驅動開發
    benefit: 高信心的頻繁合併
  - name: 功能旗標
    benefit: 不完整功能的安全部署
  - name: 監控
    benefit: 快速偵測問題

quick_reference:
  principles:
    columns: [原則, 說明]
    rows:
      - [小提交, 每次變更少於 200 行]
      - [頻繁整合, 每天多次合併到 trunk]
      - [功能旗標, 隱藏進行中功能]
      - [永遠綠燈, Trunk 永遠可部署]
      - [快速回饋, CI 在數分鐘內完成]
