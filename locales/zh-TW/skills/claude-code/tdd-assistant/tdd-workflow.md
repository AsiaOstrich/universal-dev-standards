---
source: ../../../../../skills/claude-code/tdd-assistant/tdd-workflow.md
source_version: 1.0.0
translation_version: 1.0.0
last_synced: 2026-01-07
status: current
---

# TDD 工作流程指南

> **語言**: [English](../../../../../skills/claude-code/tdd-assistant/tdd-workflow.md) | 繁體中文

**版本**: 1.0.0
**最後更新**: 2026-01-07

---

## 完整工作流程圖

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        完整 TDD 工作流程                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────┐                                                          │
│  │ 1. 理解需求   │  閱讀需求/spec/使用者故事                                 │
│  │              │  識別驗收標準                                              │
│  └───────┬───────┘                                                          │
│          │                                                                  │
│          ▼                                                                  │
│  ┌───────────────┐                                                          │
│  │ 2. 列出測試   │  腦力激盪測試案例                                         │
│  │    案例       │  快樂路徑、邊界情況、錯誤                                  │
│  └───────┬───────┘                                                          │
│          │                                                                  │
│          ▼                                                                  │
│  ┌───────────────┐                                                          │
│  │ 3. 選擇一個   │  從最簡單的案例開始                                       │
│  │    測試       │  （通常是快樂路徑）                                        │
│  └───────┬───────┘                                                          │
│          │                                                                  │
│          ▼                                                                  │
│  ┌───────────────┐                                                          │
│  │  🔴 紅色      │  撰寫失敗測試                                             │
│  │  (1-5 分鐘)   │  驗證它因正確原因失敗                                     │
│  └───────┬───────┘                                                          │
│          │                                                                  │
│          ▼                                                                  │
│  ┌───────────────┐                                                          │
│  │  🟢 綠色      │  撰寫最少程式碼讓它通過                                   │
│  │  (1-10 分鐘)  │  「假裝」是可以的                                         │
│  └───────┬───────┘                                                          │
│          │                                                                  │
│          ▼                                                                  │
│  ┌───────────────┐                                                          │
│  │  🔵 重構      │  清理程式碼                                               │
│  │  (5-15 分鐘)  │  保持測試綠色                                             │
│  └───────┬───────┘                                                          │
│          │                                                                  │
│          ▼                                                                  │
│  ┌───────────────┐     ┌─────────────────┐                                  │
│  │ 還有更多測試？│─是─▶│ 返回步驟 3      │                                   │
│  │              │      │                │                                   │
│  └───────┬───────┘      └─────────────────┘                                  │
│          │ 否                                                               │
│          ▼                                                                  │
│  ┌───────────────┐                                                          │
│  │    ✅ 完成    │  所有驗收標準達成                                         │
│  └───────────────┘                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 紅色階段深入解析

### 目標

撰寫一個測試：
- 描述預期行為（非實作）
- 因為**正確的原因**而失敗
- 有清楚、描述性的名稱

### 逐步說明

1. **選擇要測試什麼**
   - 從最簡單的場景開始
   - 專注於「一個」行為

2. **撰寫測試結構**
   ```typescript
   test('should [預期行為] when [條件]', () => {
     // Arrange - 設置測試資料

     // Act - 執行行為

     // Assert - 驗證結果
   });
   ```

3. **填寫測試**
   - Arrange：建立測試資料和依賴
   - Act：呼叫被測試的方法/函式
   - Assert：驗證預期結果

4. **執行測試**
   - 它應該「失敗」
   - 驗證失敗是因為正確的原因

### 常見錯誤

| 錯誤 | 範例 | 修復 |
|------|------|------|
| **斷言太多** | 在一個測試中測試 5 件事 | 每個測試一個行為 |
| **模糊的測試名稱** | `test('works')` | `test('should return sum of two numbers')` |
| **無斷言** | 缺少 `expect()` | 始終斷言預期結果 |
| **測試實作** | 檢查私有方法呼叫 | 測試可觀察的行為 |
| **測試已經通過** | 測試現有行為 | 為「新」行為撰寫 |

### 紅色階段檢查清單

```
□ 測試名稱清楚描述行為
□ 測試遵循 AAA 模式
□ 測試只有「一個」斷言（或相關群組）
□ 測試執行時「失敗」
□ 失敗訊息清楚
□ 失敗是因為「正確的原因」（非語法錯誤）
```

---

## 綠色階段深入解析

### 目標

撰寫**最少**的程式碼讓測試通過。

### 逐步說明

1. **分析失敗**
   - 測試期望什麼？
   - 提供它的最簡單方式是什麼？

2. **撰寫最少程式碼**
   - 對於第一個測試，硬編碼是可以的
   - 不要預期未來的需求

3. **執行測試**
   - 它應該「通過」
   - 所有其他測試應該仍然通過

### 「假裝」策略

對於第一個測試，假裝實現是完全可以的：

```typescript
// 測試：should return sum of 2 and 3
test('should return sum of two numbers', () => {
  expect(add(2, 3)).toBe(5);
});

// 第一個實現（假裝！）
function add(a: number, b: number): number {
  return 5; // 只回傳預期值
}
```

然後新增更多測試來強制泛化：

```typescript
// 第二個測試強制真正的實現
test('should return sum of 1 and 1', () => {
  expect(add(1, 1)).toBe(2);
});

// 現在我們必須泛化
function add(a: number, b: number): number {
  return a + b;
}
```

### 綠色階段檢查清單

```
□ 撰寫了「最少」程式碼讓測試通過
□ 沒有新增測試不需要的功能
□ 當前測試通過
□ 所有其他測試仍然通過
□ 沒有過早優化
```

---

## 重構階段深入解析

### 目標

在保持所有測試綠色的同時改善程式碼品質。

### 逐步說明

1. **識別程式碼異味**
   - 重複
   - 過長方法
   - 命名不佳
   - 複雜條件

2. **選擇「一個」改善**
   - 不要試圖一次修復所有東西

3. **進行變更**
   - 小的、漸進的變更

4. **立即執行測試**
   - 如果測試失敗，立即復原

5. **如有需要重複**

### 常見重構

| 技術 | 使用時機 | 範例 |
|------|---------|------|
| **提取方法** | 過長方法、重複程式碼 | 將 10 行提取到 `calculateTax()` |
| **重新命名** | 不清楚的名稱 | `x` → `totalAmount` |
| **內聯** | 不必要的間接 | 移除包裝函式 |
| **提取變數** | 複雜表達式 | `const isEligible = age >= 18 && hasId` |
| **取代魔術數字** | 硬編碼值 | `7` → `DAYS_IN_WEEK` |

### 重構安全規則

```
1. 開始前測試是綠色
2. 一次做「一個」變更
3. 「每次」變更後執行測試
4. 如果測試「失敗」→ 立即「復原」
5. 重構時絕不新增功能
```

### 重構階段檢查清單

```
□ 開始前所有測試綠色
□ 識別了具體的改善
□ 做了「一個」小變更
□ 測試仍然綠色
□ 程式碼更乾淨/簡單
□ 沒有新增功能
□ 對其他改善重複
```

---

## BDD 工作流程

### Gherkin 語法

```gherkin
Feature: [功能名稱]
  As a [角色]
  I want [目標]
  So that [好處]

  Background:
    Given [所有場景的共同設置]

  Scenario: [場景名稱]
    Given [初始情境]
    And [更多情境]
    When [動作]
    And [更多動作]
    Then [預期結果]
    And [更多結果]

  Scenario Outline: [參數化場景]
    Given [帶有 <參數> 的情境]
    When [動作]
    Then [帶有 <預期> 的結果]

    Examples:
      | 參數   | 預期    |
      | 值1    | 結果1   |
      | 值2    | 結果2   |
```

### BDD 工作流程步驟

```
┌─────────────────────────────────────────────────────────────────┐
│                        BDD 工作流程                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 探索會議                                                     │
│     ├─ 開發者、BA、QA、利益相關者一起                             │
│     ├─ 討論使用者故事                                            │
│     └─ 識別驗收標準                                              │
│                                                                 │
│  2. 制定                                                         │
│     ├─ 用 Gherkin 撰寫場景                                       │
│     ├─ 每個 AC → 一個或多個場景                                  │
│     └─ 與團隊審查                                                │
│                                                                 │
│  3. 自動化                                                       │
│     ├─ 建立 step definitions                                    │
│     ├─ 每個 step → 執行該步驟的程式碼                            │
│     └─ 為 step 實現使用 TDD                                      │
│                                                                 │
│  4. 實現                                                         │
│     ├─ 執行場景（它們失敗 - 紅色）                                │
│     ├─ 實現功能程式碼（綠色）                                     │
│     └─ 重構                                                      │
│                                                                 │
│  5. 活文件                                                       │
│     └─ 場景作為始終最新的文件                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## ATDD 工作流程

### 驗收標準格式

```markdown
## 使用者故事

**作為** [角色]
**我想要** [功能]
**以便** [好處]

## 驗收標準

### AC-1：[標準名稱]
**Given** [前置條件]
**When** [動作]
**Then** [預期結果]

### AC-2：[標準名稱]
**Given** [前置條件]
**When** [動作]
**Then** [預期結果]

## 不在範圍內
- [明確不包含的事項]

## 技術備註
- [實現提示、約束]
```

### ATDD 工作流程步驟

```
┌─────────────────────────────────────────────────────────────────┐
│                        ATDD 工作流程                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 規格研討會                                                   │
│     ├─ 產品負責人展示使用者故事                                   │
│     ├─ 團隊提出澄清問題                                          │
│     ├─ 一起定義驗收標準                                          │
│     └─ 為每個 AC 撰寫範例                                        │
│                                                                 │
│  2. 精煉                                                         │
│     ├─ 將範例轉換為可執行測試                                     │
│     ├─ 消除歧義                                                  │
│     └─ 取得產品負責人簽核                                        │
│                                                                 │
│  3. 開發                                                         │
│     ├─ 驗收測試是紅色                                            │
│     ├─ 為功能層級測試使用 BDD                                    │
│     ├─ 為單元層級測試使用 TDD                                    │
│     └─ 驗收測試變成綠色                                          │
│                                                                 │
│  4. 展示                                                         │
│     ├─ 展示通過的驗收測試                                        │
│     ├─ 產品負責人驗證                                            │
│     └─ 接受或精煉標準                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 團隊協作模式

### 使用 TDD 的結對程式設計

#### 乒乓模式

```
┌─────────────────────────────────────────────────────────────────┐
│                    乒乓 TDD                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   開發者 A                       開發者 B                        │
│   ─────────                      ─────────                       │
│   1. 撰寫失敗測試 ──────────────────────▶                        │
│                   ◀────────────────────── 2. 讓它通過            │
│                   ◀────────────────────── 3. 撰寫測試            │
│   4. 讓它通過 ────────────────────────────▶                      │
│   5. 撰寫測試 ────────────────────────────▶                      │
│                   ◀────────────────────── 6. 讓它通過            │
│                                                                 │
│   任一方都可以隨時重構                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 駕駛員-領航員模式

```
┌─────────────────────────────────────────────────────────────────┐
│                    駕駛員-領航員 TDD                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   駕駛員（鍵盤）                 領航員（思考）                    │
│   ─────────────                  ───────────────                 │
│   - 打字程式碼                   - 思考設計                       │
│   - 專注於語法                   - 考慮測試案例                   │
│   - 實現想法                     - 檢查錯誤                       │
│   - 提問                         - 建議方向                       │
│                                                                 │
│   每 15-30 分鐘交換角色                                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## CI/CD 整合

### 管線結構

```yaml
stages:
  - test:unit        # 快速 (< 2 分鐘)
  - test:integration # 中等 (< 10 分鐘)
  - test:e2e         # 慢速 (< 30 分鐘)
  - coverage-check
  - deploy
```

### 品質門檻

| 門檻 | 閾值 | 失敗時動作 |
|------|------|-----------|
| 單元測試通過率 | 100% | 阻止合併 |
| 整合測試通過率 | 100% | 阻止合併 |
| 程式碼覆蓋率 | 80% | 警告/阻止 |
| 新程式碼覆蓋率 | 90% | 警告 |
| 測試執行時間 | < 基準 | 警告 |

---

## 快速決策指南

### 要撰寫哪種測試？

```
你在實現什麼？
│
├─ 新功能
│   └─ 從驗收標準開始 → BDD → TDD
│
├─ Bug 修復
│   └─ 撰寫重現 bug 的失敗測試 → TDD
│
├─ 重構
│   └─ 確保現有測試涵蓋行為 → 重構
│
├─ 效能改善
│   └─ 撰寫效能測試 → 實現 → 驗證
│
└─ 新 API 端點
    └─ 邏輯用 TDD + HTTP 用整合測試
```

---

## 相關文件

- [SKILL.md](./SKILL.md) - TDD 助手概覽
- [語言範例](./language-examples.md) - 語言特定 TDD
- [TDD 核心標準](../../../../../core/test-driven-development.md) - 完整 TDD 標準
