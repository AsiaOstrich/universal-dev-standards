# 方法論執行時引導

> **Language**: [English](../../../../../skills/claude-code/methodology-system/runtime.md) | 繁體中文

**版本**: 1.0.0
**最後更新**: 2026-01-12

---

## 概述

本文件定義當開發方法論啟用時，AI 助手應如何行為。提供階段追蹤、檢查點處理和用戶互動的引導。

---

## AI 行為規格

### 1. 上下文感知

當方法論啟用時，AI 應該：

- **始終知道當前階段**
- **在回應中顯示階段指示器**
- **建議階段適當的行動**

#### 階段狀態顯示

在相關回應開頭包含方法論狀態：

```
┌────────────────────────────────────────────────┐
│ 📋 方法論: TDD                                  │
│ 📍 階段: 🔴 紅燈（撰寫失敗的測試）               │
│ ⏱️  持續時間: 3 分鐘                            │
└────────────────────────────────────────────────┘
```

### 2. 主動引導

根據當前階段提供上下文適當的建議：

```markdown
**當前階段: 🔴 紅燈 (TDD)**

您正在為以下功能撰寫失敗的測試：用戶登入驗證

**下一步**：撰寫描述預期行為的測試。

您希望我：
1. 產生測試骨架
2. 展示此場景的 TDD 最佳實踐
3. 繼續您的手動方式
```

### 3. 階段轉換偵測

監控表示階段轉換的條件：

| 訊號 | 轉換 |
|------|------|
| 測試執行失敗 | 紅燈 → 準備進入綠燈 |
| 所有測試通過 | 綠燈 → 準備重構 |
| 用戶確認重構完成 | 重構 → 下一個週期或完成 |
| 經過時間超過階段持續時間 | 顯示提醒 |
| 偵測到 Git 提交 | 重置階段計時器 |

### 4. 檢查點行為

當檢查點條件觸發時，顯示檢查點通知：

```
┌────────────────────────────────────────────────┐
│ 🔔 方法論檢查點                                 │
├────────────────────────────────────────────────┤
│ 綠燈階段完成                                    │
│                                                │
│ 檢查清單狀態：                                  │
│   ✅ 撰寫最少程式碼                            │
│   ✅ 測試通過                                   │
│   ✅ 所有其他測試通過                           │
│   ⬜ （選填）考慮邊界情況                       │
│                                                │
│ 變更統計：                                      │
│   - 檔案: 3                                     │
│   - 新增: 45 行                                 │
│   - 刪除: 2 行                                  │
│                                                │
│ 建議提交：                                      │
│   test(auth): 新增郵箱驗證測試                  │
│   feat(auth): 實作郵箱驗證                      │
│                                                │
│ 選項：                                          │
│   [1] 立即提交（顯示 git 命令）                 │
│   [2] 繼續到重構階段                            │
│   [3] 檢視詳細變更                              │
└────────────────────────────────────────────────┘
```

### 5. 跳過追蹤

追蹤連續跳過並適當警告：

| 跳過次數 | 行動 |
|----------|------|
| 1-2 | 無行動，記錄跳過 |
| 3 | 警告通知 |
| 4+ | 強烈警告，建議提交 |

#### 跳過警告顯示

```
┌────────────────────────────────────────────────┐
│ ⚠️ 跳過警告                                     │
├────────────────────────────────────────────────┤
│ 您已連續跳過簽入 3 次                           │
│                                                │
│ 當前累積變更：                                  │
│   - 檔案: 8                                     │
│   - 新增: 320 行                                │
│   - 刪除: 45 行                                 │
│                                                │
│ 建議：立即提交您的變更以避免遺失工作並維持      │
│ 原子化提交。                                    │
│                                                │
│ [1] 立即提交  [2] 仍然跳過  [3] 檢視差異        │
└────────────────────────────────────────────────┘
```

---

## 方法論偵測

### 自動偵測

AI 應從以下來源偵測方法論上下文：

1. **Manifest 配置**
   ```json
   // .standards/manifest.json
   { "methodology": { "active": "tdd" } }
   ```

2. **關鍵字偵測**
   - 「讓我們用 TDD 來做這個」
   - 「先寫一個失敗的測試」
   - 「Given-When-Then」
   - 「為這個變更建立規格」

3. **命令調用**
   - `/tdd`、`/bdd`、`/spec`、`/atdd`
   - `/methodology switch <id>`

### 載入方法論定義

```
方法論載入優先順序：
1. 自訂: .standards/methodologies/{id}.methodology.yaml
2. 內建: methodologies/{id}.methodology.yaml
3. 備用: 通用無階段工作流
```

---

## 檢查清單管理

### 顯示格式

```markdown
### 階段檢查清單

**必須：**
- [ ] 測試描述預期行為
- [x] 測試名稱清晰
- [ ] 測試遵循 AAA 模式

**選填：**
- [ ] 考慮邊界情況
```

### 追蹤

- 根據用戶行動和程式碼分析更新檢查清單項目
- 嚴格模式下，必填項目未完成則阻止階段轉換
- 記錄完成情況以供審計追蹤

---

## 整合點

### 與 Git

- 偵測提交以重置階段計時器
- 根據方法論建議提交訊息
- 自動包含規格/故事參考

### 與測試執行器

- 偵測測試通過/失敗以觸發階段轉換
- 報告與當前階段相關的測試覆蓋率

### 與程式碼審查

- 添加方法論特定的審查檢查
- 在 PR 描述中參考啟用的方法論

---

## 錯誤處理

### 找不到方法論

```
⚠️ 找不到方法論 'custom-workflow'。

可用的方法論：
- tdd（內建）
- bdd（內建）
- sdd（內建）
- atdd（內建）

使用 `/methodology list` 查看所有選項。
```

### 無效的階段轉換

```
⚠️ 無法從紅燈轉換到重構。

TDD 要求：紅燈 → 綠燈 → 重構

當前階段：紅燈
有效的下一個階段：綠燈

請先完成紅燈階段的檢查清單。
```

---

## 效能考量

- 首次載入後快取方法論定義
- 僅在 manifest 變更時重新載入
- 最小化檢查點頻率以避免中斷
- 批次處理 git 狀態檢查

---

## 本地化

所有面向用戶的文字應使用適當的語言欄位：

```yaml
# 如果用戶的地區設定是 zh-TW
name: nameZh || name
description: descriptionZh || description
prompt: promptZh || prompt
```

---

## 版本歷史

| 版本 | 日期 | 變更 |
|------|------|------|
| 1.0.0 | 2026-01-12 | 初始執行時規格 |
