---
source: ../../../../../skills/claude-code/tdd-assistant/tdd-workflow.md
source_version: 1.0.0
translation_version: 1.0.0
last_synced: 2026-01-07
status: current
---

# TDD 工作流程指南

> **语言**: [English](../../../../../skills/claude-code/tdd-assistant/tdd-workflow.md) | 简体中文

**版本**: 1.0.0
**最後更新**: 2026-01-07

---

## 完整工作流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        完整 TDD 工作流程                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────┐                                                          │
│  │ 1. 理解需求   │  阅读需求/spec/使用者故事                                 │
│  │              │  識别驗收标准                                              │
│  └───────┬───────┘                                                          │
│          │                                                                  │
│          ▼                                                                  │
│  ┌───────────────┐                                                          │
│  │ 2. 列出测试   │  腦力激盪测试案例                                         │
│  │    案例       │  快樂路徑、邊界情况、错误                                  │
│  └───────┬───────┘                                                          │
│          │                                                                  │
│          ▼                                                                  │
│  ┌───────────────┐                                                          │
│  │ 3. 选择一个   │  從最簡单的案例開始                                       │
│  │    测试       │  （通常是快樂路徑）                                        │
│  └───────┬───────┘                                                          │
│          │                                                                  │
│          ▼                                                                  │
│  ┌───────────────┐                                                          │
│  │  🔴 紅色      │  撰写失败测试                                             │
│  │  (1-5 分鐘)   │  验证它因正确原因失败                                     │
│  └───────┬───────┘                                                          │
│          │                                                                  │
│          ▼                                                                  │
│  ┌───────────────┐                                                          │
│  │  🟢 綠色      │  撰写最少程序码讓它通過                                   │
│  │  (1-10 分鐘)  │  「假裝」是可以的                                         │
│  └───────┬───────┘                                                          │
│          │                                                                  │
│          ▼                                                                  │
│  ┌───────────────┐                                                          │
│  │  🔵 重構      │  清理程序码                                               │
│  │  (5-15 分鐘)  │  保持测试綠色                                             │
│  └───────┬───────┘                                                          │
│          │                                                                  │
│          ▼                                                                  │
│  ┌───────────────┐     ┌─────────────────┐                                  │
│  │ 还有更多测试？│─是─▶│ 返回步骤 3      │                                   │
│  │              │      │                │                                   │
│  └───────┬───────┘      └─────────────────┘                                  │
│          │ 否                                                               │
│          ▼                                                                  │
│  ┌───────────────┐                                                          │
│  │    ✅ 完成    │  所有驗收标准达成                                         │
│  └───────────────┘                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 紅色阶段深入解析

### 目標

撰写一个测试：
- 描述预期行为（非实作）
- 因为**正确的原因**而失败
- 有清楚、描述性的名称

### 逐步说明

1. **选择要测试什麼**
   - 從最簡单的場景開始
   - 專注於「一个」行为

2. **撰写测试结构**
   ```typescript
   test('should [预期行为] when [条件]', () => {
     // Arrange - 设置测试数据

     // Act - 执行行为

     // Assert - 验证結果
   });
   ```

3. **填写测试**
   - Arrange：建立测试数据和依賴
   - Act：呼叫被测试的方法/函式
   - Assert：验证预期結果

4. **执行测试**
   - 它应該「失败」
   - 验证失败是因为正确的原因

### 常見错误

| 错误 | 範例 | 修復 |
|------|------|------|
| **斷言太多** | 在一个测试中测试 5 件事 | 每个测试一个行为 |
| **模糊的测试名称** | `test('works')` | `test('should return sum of two numbers')` |
| **無斷言** | 缺少 `expect()` | 始終斷言预期結果 |
| **测试实作** | 检查私有方法呼叫 | 测试可觀察的行为 |
| **测试已經通過** | 测试現有行为 | 为「新」行为撰写 |

### 紅色阶段检查清单

```
□ 测试名称清楚描述行为
□ 测试遵循 AAA 模式
□ 测试只有「一个」斷言（或相关群組）
□ 测试执行时「失败」
□ 失败消息清楚
□ 失败是因为「正确的原因」（非語法错误）
```

---

## 綠色阶段深入解析

### 目標

撰写**最少**的程序码讓测试通過。

### 逐步说明

1. **分析失败**
   - 测试期望什麼？
   - 提供它的最簡单方式是什麼？

2. **撰写最少程序码**
   - 对於第一个测试，硬编码是可以的
   - 不要预期未來的需求

3. **执行测试**
   - 它应該「通過」
   - 所有其他测试应該仍然通過

### 「假裝」策略

对於第一个测试，假裝实現是完全可以的：

```typescript
// 测试：should return sum of 2 and 3
test('should return sum of two numbers', () => {
  expect(add(2, 3)).toBe(5);
});

// 第一个实現（假裝！）
function add(a: number, b: number): number {
  return 5; // 只回传预期值
}
```

然後新增更多测试來強制泛化：

```typescript
// 第二个测试強制真正的实現
test('should return sum of 1 and 1', () => {
  expect(add(1, 1)).toBe(2);
});

// 現在我們必須泛化
function add(a: number, b: number): number {
  return a + b;
}
```

### 綠色阶段检查清单

```
□ 撰写了「最少」程序码讓测试通過
□ 没有新增测试不需要的功能
□ 當前测试通過
□ 所有其他测试仍然通過
□ 没有過早優化
```

---

## 重構阶段深入解析

### 目標

在保持所有测试綠色的同时改善程序码品质。

### 逐步说明

1. **識别程序码異味**
   - 重複
   - 過長方法
   - 命名不佳
   - 複雜条件

2. **选择「一个」改善**
   - 不要試图一次修復所有東西

3. **进行变更**
   - 小的、漸进的变更

4. **立即执行测试**
   - 如果测试失败，立即復原

5. **如有需要重複**

### 常見重構

| 技術 | 使用时机 | 範例 |
|------|---------|------|
| **提取方法** | 過長方法、重複程序码 | 將 10 行提取到 `calculateTax()` |
| **重新命名** | 不清楚的名称 | `x` → `totalAmount` |
| **內联** | 不必要的间接 | 移除包裝函式 |
| **提取变數** | 複雜表达式 | `const isEligible = age >= 18 && hasId` |
| **取代魔術數字** | 硬编码值 | `7` → `DAYS_IN_WEEK` |

### 重構安全規則

```
1. 開始前测试是綠色
2. 一次做「一个」变更
3. 「每次」变更後执行测试
4. 如果测试「失败」→ 立即「復原」
5. 重構时絕不新增功能
```

### 重構阶段检查清单

```
□ 開始前所有测试綠色
□ 識别了具体的改善
□ 做了「一个」小变更
□ 测试仍然綠色
□ 程序码更乾淨/簡单
□ 没有新增功能
□ 对其他改善重複
```

---

## BDD 工作流程

### Gherkin 語法

```gherkin
Feature: [功能名称]
  As a [角色]
  I want [目標]
  So that [好处]

  Background:
    Given [所有場景的共同设置]

  Scenario: [場景名称]
    Given [初始情境]
    And [更多情境]
    When [动作]
    And [更多动作]
    Then [预期結果]
    And [更多結果]

  Scenario Outline: [參數化場景]
    Given [帶有 <參數> 的情境]
    When [动作]
    Then [帶有 <预期> 的結果]

    Examples:
      | 參數   | 预期    |
      | 值1    | 結果1   |
      | 值2    | 結果2   |
```

### BDD 工作流程步骤

```
┌─────────────────────────────────────────────────────────────────┐
│                        BDD 工作流程                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 探索会議                                                     │
│     ├─ 开发者、BA、QA、利益相关者一起                             │
│     ├─ 討論使用者故事                                            │
│     └─ 識别驗收标准                                              │
│                                                                 │
│  2. 制定                                                         │
│     ├─ 用 Gherkin 撰写場景                                       │
│     ├─ 每个 AC → 一个或多个場景                                  │
│     └─ 与团队审查                                                │
│                                                                 │
│  3. 自动化                                                       │
│     ├─ 建立 step definitions                                    │
│     ├─ 每个 step → 执行該步骤的程序码                            │
│     └─ 为 step 实現使用 TDD                                      │
│                                                                 │
│  4. 实現                                                         │
│     ├─ 执行場景（它們失败 - 紅色）                                │
│     ├─ 实現功能程序码（綠色）                                     │
│     └─ 重構                                                      │
│                                                                 │
│  5. 活文件                                                       │
│     └─ 場景作为始終最新的文件                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## ATDD 工作流程

### 驗收标准格式

```markdown
## 使用者故事

**作为** [角色]
**我想要** [功能]
**以便** [好处]

## 驗收标准

### AC-1：[标准名称]
**Given** [前置条件]
**When** [动作]
**Then** [预期結果]

### AC-2：[标准名称]
**Given** [前置条件]
**When** [动作]
**Then** [预期結果]

## 不在範圍內
- [明确不包含的事项]

## 技術备註
- [实現提示、約束]
```

### ATDD 工作流程步骤

```
┌─────────────────────────────────────────────────────────────────┐
│                        ATDD 工作流程                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 規格研討会                                                   │
│     ├─ 产品負責人展示使用者故事                                   │
│     ├─ 团队提出澄清問題                                          │
│     ├─ 一起定義驗收标准                                          │
│     └─ 为每个 AC 撰写範例                                        │
│                                                                 │
│  2. 精煉                                                         │
│     ├─ 將範例转换为可执行测试                                     │
│     ├─ 消除歧義                                                  │
│     └─ 取得产品負責人簽核                                        │
│                                                                 │
│  3. 开发                                                         │
│     ├─ 驗收测试是紅色                                            │
│     ├─ 为功能层级测试使用 BDD                                    │
│     ├─ 为单元层级测试使用 TDD                                    │
│     └─ 驗收测试变成綠色                                          │
│                                                                 │
│  4. 展示                                                         │
│     ├─ 展示通過的驗收测试                                        │
│     ├─ 产品負責人验证                                            │
│     └─ 接受或精煉标准                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 团队协作模式

### 使用 TDD 的結对程序设计

#### 乒乓模式

```
┌─────────────────────────────────────────────────────────────────┐
│                    乒乓 TDD                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   开发者 A                       开发者 B                        │
│   ─────────                      ─────────                       │
│   1. 撰写失败测试 ──────────────────────▶                        │
│                   ◀────────────────────── 2. 讓它通過            │
│                   ◀────────────────────── 3. 撰写测试            │
│   4. 讓它通過 ────────────────────────────▶                      │
│   5. 撰写测试 ────────────────────────────▶                      │
│                   ◀────────────────────── 6. 讓它通過            │
│                                                                 │
│   任一方都可以隨时重構                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 駕駛員-領航員模式

```
┌─────────────────────────────────────────────────────────────────┐
│                    駕駛員-領航員 TDD                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   駕駛員（鍵盤）                 領航員（思考）                    │
│   ─────────────                  ───────────────                 │
│   - 打字程序码                   - 思考设计                       │
│   - 專注於語法                   - 考慮测试案例                   │
│   - 实現想法                     - 检查错误                       │
│   - 提問                         - 建议方向                       │
│                                                                 │
│   每 15-30 分鐘交换角色                                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## CI/CD 集成

### 管线结构

```yaml
stages:
  - test:unit        # 快速 (< 2 分鐘)
  - test:integration # 中等 (< 10 分鐘)
  - test:e2e         # 慢速 (< 30 分鐘)
  - coverage-check
  - deploy
```

### 品质門檻

| 門檻 | 閾值 | 失败时动作 |
|------|------|-----------|
| 单元测试通過率 | 100% | 阻止合併 |
| 集成测试通過率 | 100% | 阻止合併 |
| 程序码覆蓋率 | 80% | 警告/阻止 |
| 新程序码覆蓋率 | 90% | 警告 |
| 测试执行时间 | < 基准 | 警告 |

---

## 快速决策指南

### 要撰写哪种测试？

```
你在实現什麼？
│
├─ 新功能
│   └─ 從驗收标准開始 → BDD → TDD
│
├─ Bug 修復
│   └─ 撰写重現 bug 的失败测试 → TDD
│
├─ 重構
│   └─ 确保現有测试涵蓋行为 → 重構
│
├─ 效能改善
│   └─ 撰写效能测试 → 实現 → 验证
│
└─ 新 API 端点
    └─ 邏辑用 TDD + HTTP 用集成测试
```

---

## 相关文件

- [SKILL.md](./SKILL.md) - TDD 助手概覽
- [语言範例](./language-examples.md) - 语言特定 TDD
- [TDD 核心标准](../../../../../core/test-driven-development.md) - 完整 TDD 标准
