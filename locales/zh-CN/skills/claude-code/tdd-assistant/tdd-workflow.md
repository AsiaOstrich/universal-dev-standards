---
source: ../../../../../skills/claude-code/tdd-assistant/tdd-workflow.md
source_version: 1.0.0
translation_version: 1.0.0
last_synced: 2026-01-07
status: current
---

# TDD 工作流程指南

> **语言**: [English](../../../../../skills/claude-code/tdd-assistant/tdd-workflow.md) | 繁体中文

**版本**: 1.0.0
**最后更新**: 2026-01-07

---

## 完整工作流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        完整 TDD 工作流程                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────┐                                                          │
│  │ 1. 理解需求   │  阅读需求/spec/使用者故事                                 │
│  │              │  识别验收标准                                              │
│  └───────┬───────┘                                                          │
│          │                                                                  │
│          ▼                                                                  │
│  ┌───────────────┐                                                          │
│  │ 2. 列出测试   │  脑力激荡测试案例                                         │
│  │    案例       │  快乐路径、边界情况、错误                                  │
│  └───────┬───────┘                                                          │
│          │                                                                  │
│          ▼                                                                  │
│  ┌───────────────┐                                                          │
│  │ 3. 选择一个   │  从最简单的案例开始                                       │
│  │    测试       │  （通常是快乐路径）                                        │
│  └───────┬───────┘                                                          │
│          │                                                                  │
│          ▼                                                                  │
│  ┌───────────────┐                                                          │
│  │  🔴 红色      │  撰写失败测试                                             │
│  │  (1-5 分钟)   │  验证它因正确原因失败                                     │
│  └───────┬───────┘                                                          │
│          │                                                                  │
│          ▼                                                                  │
│  ┌───────────────┐                                                          │
│  │  🟢 绿色      │  撰写最少程式码让它通过                                   │
│  │  (1-10 分钟)  │  「假装」是可以的                                         │
│  └───────┬───────┘                                                          │
│          │                                                                  │
│          ▼                                                                  │
│  ┌───────────────┐                                                          │
│  │  🔵 重构      │  清理程式码                                               │
│  │  (5-15 分钟)  │  保持测试绿色                                             │
│  └───────┬───────┘                                                          │
│          │                                                                  │
│          ▼                                                                  │
│  ┌───────────────┐     ┌─────────────────┐                                  │
│  │ 还有更多测试？│─是─▶│ 返回步骤 3      │                                   │
│  │              │      │                │                                   │
│  └───────┬───────┘      └─────────────────┘                                  │
│          │ 否                                                               │
│          ▼                                                                  │
│  ┌───────────────┐                                                          │
│  │    ✅ 完成    │  所有验收标准达成                                         │
│  └───────────────┘                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 红色阶段深入解析

### 目标

撰写一个测试：
- 描述预期行为（非实作）
- 因为**正确的原因**而失败
- 有清楚、描述性的名称

### 逐步说明

1. **选择要测试什么**
   - 从最简单的场景开始
   - 专注于「一个」行为

2. **撰写测试结构**
   ```typescript
   test('should [预期行为] when [条件]', () => {
     // Arrange - 设置测试资料

     // Act - 执行行为

     // Assert - 验证结果
   });
   ```

3. **填写测试**
   - Arrange：建立测试资料和依赖
   - Act：呼叫被测试的方法/函式
   - Assert：验证预期结果

4. **执行测试**
   - 它应该「失败」
   - 验证失败是因为正确的原因

### 常见错误

| 错误 | 范例 | 修复 |
|------|------|------|
| **断言太多** | 在一个测试中测试 5 件事 | 每个测试一个行为 |
| **模糊的测试名称** | `test('works')` | `test('should return sum of two numbers')` |
| **无断言** | 缺少 `expect()` | 始终断言预期结果 |
| **测试实作** | 检查私有方法呼叫 | 测试可观察的行为 |
| **测试已经通过** | 测试现有行为 | 为「新」行为撰写 |

### 红色阶段检查清单

```
□ 测试名称清楚描述行为
□ 测试遵循 AAA 模式
□ 测试只有「一个」断言（或相关群组）
□ 测试执行时「失败」
□ 失败讯息清楚
□ 失败是因为「正确的原因」（非语法错误）
```

---

## 绿色阶段深入解析

### 目标

撰写**最少**的程式码让测试通过。

### 逐步说明

1. **分析失败**
   - 测试期望什么？
   - 提供它的最简单方式是什么？

2. **撰写最少程式码**
   - 对于第一个测试，硬编码是可以的
   - 不要预期未来的需求

3. **执行测试**
   - 它应该「通过」
   - 所有其他测试应该仍然通过

### 「假装」策略

对于第一个测试，假装实现是完全可以的：

```typescript
// 测试：should return sum of 2 and 3
test('should return sum of two numbers', () => {
  expect(add(2, 3)).toBe(5);
});

// 第一个实现（假装！）
function add(a: number, b: number): number {
  return 5; // 只回传预期值
}
```

然后新增更多测试来强制泛化：

```typescript
// 第二个测试强制真正的实现
test('should return sum of 1 and 1', () => {
  expect(add(1, 1)).toBe(2);
});

// 现在我们必须泛化
function add(a: number, b: number): number {
  return a + b;
}
```

### 绿色阶段检查清单

```
□ 撰写了「最少」程式码让测试通过
□ 没有新增测试不需要的功能
□ 当前测试通过
□ 所有其他测试仍然通过
□ 没有过早优化
```

---

## 重构阶段深入解析

### 目标

在保持所有测试绿色的同时改善程式码品质。

### 逐步说明

1. **识别程式码异味**
   - 重复
   - 过长方法
   - 命名不佳
   - 复杂条件

2. **选择「一个」改善**
   - 不要试图一次修复所有东西

3. **进行变更**
   - 小的、渐进的变更

4. **立即执行测试**
   - 如果测试失败，立即复原

5. **如有需要重复**

### 常见重构

| 技术 | 使用时机 | 范例 |
|------|---------|------|
| **提取方法** | 过长方法、重复程式码 | 将 10 行提取到 `calculateTax()` |
| **重新命名** | 不清楚的名称 | `x` → `totalAmount` |
| **内联** | 不必要的间接 | 移除包装函式 |
| **提取变数** | 复杂表达式 | `const isEligible = age >= 18 && hasId` |
| **取代魔术数字** | 硬编码值 | `7` → `DAYS_IN_WEEK` |

### 重构安全规则

```
1. 开始前测试是绿色
2. 一次做「一个」变更
3. 「每次」变更后执行测试
4. 如果测试「失败」→ 立即「复原」
5. 重构时绝不新增功能
```

### 重构阶段检查清单

```
□ 开始前所有测试绿色
□ 识别了具体的改善
□ 做了「一个」小变更
□ 测试仍然绿色
□ 程式码更干净/简单
□ 没有新增功能
□ 对其他改善重复
```

---

## BDD 工作流程

### Gherkin 语法

```gherkin
Feature: [功能名称]
  As a [角色]
  I want [目标]
  So that [好处]

  Background:
    Given [所有场景的共同设置]

  Scenario: [场景名称]
    Given [初始情境]
    And [更多情境]
    When [动作]
    And [更多动作]
    Then [预期结果]
    And [更多结果]

  Scenario Outline: [参数化场景]
    Given [带有 <参数> 的情境]
    When [动作]
    Then [带有 <预期> 的结果]

    Examples:
      | 参数   | 预期    |
      | 值1    | 结果1   |
      | 值2    | 结果2   |
```

### BDD 工作流程步骤

```
┌─────────────────────────────────────────────────────────────────┐
│                        BDD 工作流程                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 探索会议                                                     │
│     ├─ 开发者、BA、QA、利益相关者一起                             │
│     ├─ 讨论使用者故事                                            │
│     └─ 识别验收标准                                              │
│                                                                 │
│  2. 制定                                                         │
│     ├─ 用 Gherkin 撰写场景                                       │
│     ├─ 每个 AC → 一个或多个场景                                  │
│     └─ 与团队审查                                                │
│                                                                 │
│  3. 自动化                                                       │
│     ├─ 建立 step definitions                                    │
│     ├─ 每个 step → 执行该步骤的程式码                            │
│     └─ 为 step 实现使用 TDD                                      │
│                                                                 │
│  4. 实现                                                         │
│     ├─ 执行场景（它们失败 - 红色）                                │
│     ├─ 实现功能程式码（绿色）                                     │
│     └─ 重构                                                      │
│                                                                 │
│  5. 活文件                                                       │
│     └─ 场景作为始终最新的文件                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## ATDD 工作流程

### 验收标准格式

```markdown
## 使用者故事

**作为** [角色]
**我想要** [功能]
**以便** [好处]

## 验收标准

### AC-1：[标准名称]
**Given** [前置条件]
**When** [动作]
**Then** [预期结果]

### AC-2：[标准名称]
**Given** [前置条件]
**When** [动作]
**Then** [预期结果]

## 不在范围内
- [明确不包含的事项]

## 技术备注
- [实现提示、约束]
```

### ATDD 工作流程步骤

```
┌─────────────────────────────────────────────────────────────────┐
│                        ATDD 工作流程                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 规格研讨会                                                   │
│     ├─ 产品负责人展示使用者故事                                   │
│     ├─ 团队提出澄清问题                                          │
│     ├─ 一起定义验收标准                                          │
│     └─ 为每个 AC 撰写范例                                        │
│                                                                 │
│  2. 精炼                                                         │
│     ├─ 将范例转换为可执行测试                                     │
│     ├─ 消除歧义                                                  │
│     └─ 取得产品负责人签核                                        │
│                                                                 │
│  3. 开发                                                         │
│     ├─ 验收测试是红色                                            │
│     ├─ 为功能层级测试使用 BDD                                    │
│     ├─ 为单元层级测试使用 TDD                                    │
│     └─ 验收测试变成绿色                                          │
│                                                                 │
│  4. 展示                                                         │
│     ├─ 展示通过的验收测试                                        │
│     ├─ 产品负责人验证                                            │
│     └─ 接受或精炼标准                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 团队协作模式

### 使用 TDD 的结对程式设计

#### 乒乓模式

```
┌─────────────────────────────────────────────────────────────────┐
│                    乒乓 TDD                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   开发者 A                       开发者 B                        │
│   ─────────                      ─────────                       │
│   1. 撰写失败测试 ──────────────────────▶                        │
│                   ◀────────────────────── 2. 让它通过            │
│                   ◀────────────────────── 3. 撰写测试            │
│   4. 让它通过 ────────────────────────────▶                      │
│   5. 撰写测试 ────────────────────────────▶                      │
│                   ◀────────────────────── 6. 让它通过            │
│                                                                 │
│   任一方都可以随时重构                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 驾驶员-领航员模式

```
┌─────────────────────────────────────────────────────────────────┐
│                    驾驶员-领航员 TDD                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   驾驶员（键盘）                 领航员（思考）                    │
│   ─────────────                  ───────────────                 │
│   - 打字程式码                   - 思考设计                       │
│   - 专注于语法                   - 考虑测试案例                   │
│   - 实现想法                     - 检查错误                       │
│   - 提问                         - 建议方向                       │
│                                                                 │
│   每 15-30 分钟交换角色                                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## CI/CD 整合

### 管线结构

```yaml
stages:
  - test:unit        # 快速 (< 2 分钟)
  - test:integration # 中等 (< 10 分钟)
  - test:e2e         # 慢速 (< 30 分钟)
  - coverage-check
  - deploy
```

### 品质门槛

| 门槛 | 阈值 | 失败时动作 |
|------|------|-----------|
| 单元测试通过率 | 100% | 阻止合并 |
| 整合测试通过率 | 100% | 阻止合并 |
| 程式码覆盖率 | 80% | 警告/阻止 |
| 新程式码覆盖率 | 90% | 警告 |
| 测试执行时间 | < 基准 | 警告 |

---

## 快速决策指南

### 要撰写哪种测试？

```
你在实现什么？
│
├─ 新功能
│   └─ 从验收标准开始 → BDD → TDD
│
├─ Bug 修复
│   └─ 撰写重现 bug 的失败测试 → TDD
│
├─ 重构
│   └─ 确保现有测试涵盖行为 → 重构
│
├─ 效能改善
│   └─ 撰写效能测试 → 实现 → 验证
│
└─ 新 API 端点
    └─ 逻辑用 TDD + HTTP 用整合测试
```

---

## 相关文件

- [SKILL.md](./SKILL.md) - TDD 助手概览
- [语言范例](./language-examples.md) - 语言特定 TDD
- [TDD 核心标准](../../../../../core/test-driven-development.md) - 完整 TDD 标准
